# =============================================================================
# VYBZZ AUTOMATED DEPLOYMENT WORKFLOW
# =============================================================================
# ÛŒÛ ÙØ§Ø¦Ù„ GitHub Actions Ú©Û’ Ø°Ø±ÛŒØ¹Û’ Ø®ÙˆØ¯Ú©Ø§Ø± deployment Ú©Ø§ Ø§Ù†ØªØ¸Ø§Ù… Ú©Ø±ØªÛŒ ÛÛ’
# This file manages automated deployment through GitHub Actions
#
# TRIGGER: Ø¬Ø¨ Ø¨Ú¾ÛŒ Ø¢Ù¾ main branch Ù¾Ø± code push Ú©Ø±ÛŒÚº Ú¯Û’
# TRIGGER: Whenever you push code to the main branch
#
# PROCESS:
# 1. Code checkout Ú©Ø±ØªØ§ ÛÛ’
# 2. Digital Ocean server Ù¾Ø± SSH Ú©Ø±ØªØ§ ÛÛ’
# 3. Latest code pull Ú©Ø±ØªØ§ ÛÛ’
# 4. Docker containers Ú©Ùˆ rebuild Ø§ÙˆØ± restart Ú©Ø±ØªØ§ ÛÛ’
# 5. Health checks Ú†Ù„Ø§ØªØ§ ÛÛ’
# 6. Ø§Ú¯Ø± Ú©Ú†Ú¾ ØºÙ„Ø· ÛÙˆ ØªÙˆ rollback Ú©Ø±ØªØ§ ÛÛ’
# =============================================================================

name: Deploy to Digital Ocean

on:
  push:
    branches:
      - main  # ØµØ±Ù main branch Ù¾Ø± push ÛÙˆÙ†Û’ Ù¾Ø± deployment ÛÙˆÚ¯ÛŒ
              # Deployment will trigger only on push to main branch
  
  workflow_dispatch:  # Manual trigger Ø¨Ú¾ÛŒ Ù…Ù…Ú©Ù† ÛÛ’ GitHub UI Ø³Û’
                      # Manual trigger is also possible from GitHub UI

env:
  # Environment variables jo sari jobs Ù…ÛŒÚº available ÛÙˆÚº Ú¯Û’
  # Environment variables that will be available in all jobs
  DEPLOY_PATH: /root/vybzz  # Server Ù¾Ø± project Ú©Ø§ path
  DOCKER_BUILDKIT: 1        # Fast builds Ú©Û’ Ù„ÛŒÛ’
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # =============================================================================
  # JOB 1: DEPLOYMENT
  # =============================================================================
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      # -------------------------------------------------------------------------
      # STEP 1: Ú©ÙˆÚˆ Ú†ÛŒÚ© Ø¢Ø¤Ù¹ Ú©Ø±Ù†Ø§
      # Checkout the code from repository
      # -------------------------------------------------------------------------
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ù¾ÙˆØ±ÛŒ Git history Ù„Ø§Ù†Û’ Ú©Û’ Ù„ÛŒÛ’ (rollback Ú©Û’ Ù„ÛŒÛ’ Ø¶Ø±ÙˆØ±ÛŒ)
                          # Fetch full Git history (needed for rollback)

      # -------------------------------------------------------------------------
      # STEP 2: SSH Ú©ÛŒ ØªÛŒØ§Ø±ÛŒ
      # Setup SSH connection to Digital Ocean
      # -------------------------------------------------------------------------
      - name: ğŸ” Setup SSH Key
        run: |
          # SSH private key Ú©Ùˆ temporary file Ù…ÛŒÚº save Ú©Ø±Ù†Ø§
          # Save SSH private key to a temporary file
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Server Ú©ÛŒ fingerprint Ú©Ùˆ known_hosts Ù…ÛŒÚº add Ú©Ø±Ù†Ø§
          # Add server fingerprint to known_hosts
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
          
          echo "âœ… SSH setup complete"

      # -------------------------------------------------------------------------
      # STEP 3: SERVER ØµØ­Øª Ú©ÛŒ Ø¬Ø§Ù†Ú† (Pre-deployment)
      # Check server health before deployment
      # -------------------------------------------------------------------------
      - name: ğŸ¥ Pre-deployment Health Check
        run: |
          echo "ğŸ” Checking server connectivity..."
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} "
            echo 'âœ… Server is reachable'
            echo 'ğŸ’¾ Disk space:'
            df -h | grep -E '^/dev/'
            echo 'ğŸ§  Memory usage:'
            free -h
            echo 'ğŸ³ Docker status:'
            docker --version
            docker-compose --version
          "

      # -------------------------------------------------------------------------
      # STEP 4: Ù…ÙˆØ¬ÙˆØ¯Û CONTAINERS Ú©ÛŒ Ø­Ø§Ù„Øª Ù…Ø­ÙÙˆØ¸ Ú©Ø±Ù†Ø§
      # Save current state for potential rollback
      # -------------------------------------------------------------------------
      - name: ğŸ’¾ Backup Current State
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            # Ù…ÙˆØ¬ÙˆØ¯Û Git commit hash save Ú©Ø±Ù†Ø§
            # Save current Git commit hash
            git rev-parse HEAD > .last_successful_deploy || echo 'first_deploy' > .last_successful_deploy
            
            # Ù…ÙˆØ¬ÙˆØ¯Û containers Ú©ÛŒ list save Ú©Ø±Ù†Ø§
            # Save list of running containers
            docker ps --format '{{.Names}}' > .running_containers.bak || true
            
            echo 'âœ… Backup complete'
          "

      # -------------------------------------------------------------------------
      # STEP 5: CODE Ú©Ùˆ SERVER Ù¾Ø± PULL Ú©Ø±Ù†Ø§
      # Pull latest code on the server
      # -------------------------------------------------------------------------
      - name: ğŸ“¦ Deploy Code to Server
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            # Project directory Ù…ÛŒÚº Ø¬Ø§Ù†Ø§
            # Navigate to project directory
            cd $DEPLOY_PATH
            
            echo 'ğŸ“¥ Pulling latest code from GitHub...'
            git fetch --all
            git reset --hard origin/main
            
            # Git info Ø¯Ú©Ú¾Ø§Ù†Ø§
            # Display Git info
            echo 'ğŸ“Œ Current commit:'
            git log -1 --oneline
            
            echo 'âœ… Code updated successfully'
          "

      # -------------------------------------------------------------------------
      # STEP 6: ENVIRONMENT VARIABLES Ú©ÛŒ Ø¬Ø§Ù†Ú†
      # Verify environment variables are present
      # -------------------------------------------------------------------------
      - name: ğŸ” Verify Environment Variables
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'ğŸ” Checking for required .env files...'
            
            # Check all service .env files
            MISSING_FILES=0
            
            for service in Backend/api-gateway Backend/services/auth-service Backend/services/post-service Backend/services/live-streaming-service; do
              if [ ! -f \$service/.env ]; then
                echo 'âŒ Missing: \$service/.env'
                MISSING_FILES=1
              else
                echo 'âœ… Found: \$service/.env'
              fi
            done
            
            if [ \$MISSING_FILES -eq 1 ]; then
              echo 'âš ï¸  Warning: Ú©Ú†Ú¾ .env files missing ÛÛŒÚº'
              echo 'âš ï¸  Warning: Some .env files are missing'
              echo 'Deployment Ø¬Ø§Ø±ÛŒ Ø±ÛÛ’ Ú¯ÛŒ Ù„ÛŒÚ©Ù† services fail ÛÙˆ Ø³Ú©ØªÛŒ ÛÛŒÚº'
              echo 'Deployment will continue but services may fail'
            fi
          "

      # -------------------------------------------------------------------------
      # STEP 7: DOCKER IMAGES Ú©Ùˆ BUILD Ú©Ø±Ù†Ø§
      # Build Docker images with latest code
      # -------------------------------------------------------------------------
      - name: ğŸ—ï¸  Build Docker Images
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'ğŸ—ï¸  Building Docker images...'
            echo 'ÛŒÛ process 5-10 Ù…Ù†Ù¹ Ù„Û’ Ø³Ú©ØªØ§ ÛÛ’'
            echo 'This process may take 5-10 minutes'
            
            # Production compose file Ø§Ø³ØªØ¹Ù…Ø§Ù„ Ú©Ø±ØªÛ’ ÛÙˆØ¦Û’ build Ú©Ø±Ù†Ø§
            # Build using production compose file
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml build --no-cache
            
            echo 'âœ… Docker images built successfully'
          "

      # -------------------------------------------------------------------------
      # STEP 8: PURANI CONTAINERS Ú©Ùˆ Ø±ÙˆÚ©Ù†Ø§
      # Stop old containers gracefully
      # -------------------------------------------------------------------------
      - name: ğŸ›‘ Stop Old Containers
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'ğŸ›‘ Stopping existing containers...'
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
            
            echo 'âœ… Old containers stopped'
          "

      # -------------------------------------------------------------------------
      # STEP 9: NAYI CONTAINERS Ø´Ø±ÙˆØ¹ Ú©Ø±Ù†Ø§
      # Start new containers
      # -------------------------------------------------------------------------
      - name: ğŸš€ Start New Containers
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'ğŸš€ Starting new containers...'
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
            
            echo 'â³ Ú©Ú†Ú¾ Ø³ÛŒÚ©Ù†Úˆ Ø§Ù†ØªØ¸Ø§Ø± Ú©Ø±ÛŒÚº containers Ø´Ø±ÙˆØ¹ ÛÙˆÙ†Û’ ØªÚ©...'
            echo 'â³ Waiting a few seconds for containers to start...'
            sleep 10
            
            echo 'ğŸ“‹ Container status:'
            docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps
          "

      # -------------------------------------------------------------------------
      # STEP 10: DATABASE MIGRATIONS Ú†Ù„Ø§Ù†Ø§
      # Run database migrations
      # -------------------------------------------------------------------------
      - name: ğŸ—„ï¸  Run Database Migrations
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'ğŸ—„ï¸  Running database migrations...'
            
            # User service migrations
            echo 'Running user-service migrations...'
            docker exec user-service npx prisma migrate deploy || echo 'âš ï¸  User migrations may have failed'
            
            # Post service migrations
            echo 'Running post-service migrations...'
            docker exec post-service npx prisma migrate deploy || echo 'âš ï¸  Post migrations may have failed'
            
            # Live streaming service migrations
            echo 'Running live-streaming-service migrations...'
            docker exec live-streaming-service npx prisma migrate deploy || echo 'âš ï¸  Livestream migrations may have failed'
            
            echo 'âœ… Migrations completed'
          "

      # -------------------------------------------------------------------------
      # STEP 11: HEALTH CHECKS
      # Verify all services are running properly
      # -------------------------------------------------------------------------
      - name: ğŸ¥ Health Check All Services
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'ğŸ¥ Checking health of all services...'
            
            # Health check function
            check_health() {
              local service_name=\$1
              local health_url=\$2
              local max_attempts=30
              local attempt=1
              
              echo \"Checking \$service_name...\"
              
              while [ \$attempt -le \$max_attempts ]; do
                if docker exec \${service_name} curl -f \${health_url} > /dev/null 2>&1; then
                  echo \"âœ… \$service_name is healthy\"
                  return 0
                fi
                echo \"â³ Attempt \$attempt/\$max_attempts - waiting for \$service_name...\"
                sleep 2
                attempt=\$((attempt + 1))
              done
              
              echo \"âŒ \$service_name health check failed\"
              return 1
            }
            
            # ØªÙ…Ø§Ù… services Ú©ÛŒ health check Ú©Ø±Ù†Ø§
            # Check health of all services
            FAILED=0
            
            check_health 'api-gateway' 'http://localhost:3000/health' || FAILED=1
            check_health 'auth-service' 'http://localhost:3001/health' || FAILED=1
            check_health 'user-service' 'http://localhost:3002/health' || FAILED=1
            check_health 'post-service' 'http://localhost:3003/health' || FAILED=1
            check_health 'live-streaming-service' 'http://localhost:3004/health' || FAILED=1
            
            if [ \$FAILED -eq 1 ]; then
              echo 'âŒ Some services failed health checks'
              echo 'ğŸ“‹ Container logs:'
              docker-compose -f docker-compose.yml -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
            
            echo 'âœ… All services are healthy!'
          "

      # -------------------------------------------------------------------------
      # STEP 12: PURANY DOCKER IMAGES ØµØ§Ù Ú©Ø±Ù†Ø§
      # Clean up old Docker images to save space
      # -------------------------------------------------------------------------
      - name: ğŸ§¹ Cleanup Old Images
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            echo 'ğŸ§¹ Cleaning up unused Docker resources...'
            
            # Ù¾Ø±Ø§Ù†ÛŒ images Ø§ÙˆØ± containers ØµØ§Ù Ú©Ø±Ù†Ø§
            # Clean up old images and containers
            docker system prune -af --filter 'until=24h' || true
            
            echo 'ğŸ’¾ Remaining disk space:'
            df -h | grep -E '^/dev/'
            
            echo 'âœ… Cleanup complete'
          "

      # -------------------------------------------------------------------------
      # STEP 13: DEPLOYMENT SUCCESS Ú©Ø§ Ø±ÛŒÚ©Ø§Ø±Úˆ
      # Record successful deployment
      # -------------------------------------------------------------------------
      - name: âœ… Mark Deployment Successful
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            # Ù…ÙˆØ¬ÙˆØ¯Û commit Ú©Ùˆ successful deployment Ú©Û’ Ø·ÙˆØ± Ù¾Ø± mark Ú©Ø±Ù†Ø§
            # Mark current commit as successful deployment
            git rev-parse HEAD > .last_successful_deploy
            
            echo 'âœ… Deployment completed successfully!'
            echo 'ğŸ‰ Vybzz is now running the latest version!'
            echo ''
            echo 'ğŸ“Š Deployment Summary:'
            echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
            echo \"Deployed Commit: \$(git log -1 --oneline)\"
            echo \"Deployment Time: \$(date)\"
            echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'
          "

      # -------------------------------------------------------------------------
      # STEP 14: SSH Ú©ÛŒ ØµÙØ§Ø¦ÛŒ
      # Cleanup SSH keys
      # -------------------------------------------------------------------------
      - name: ğŸ§¹ Cleanup SSH
        if: always()  # ÛŒÛ ÛÙ…ÛŒØ´Û Ú†Ù„Û’ Ú¯Ø§ Ú†Ø§ÛÛ’ Ú©Ú†Ú¾ Ø¨Ú¾ÛŒ ÛÙˆ
                     # This will always run regardless of success/failure
        run: |
          rm -f ~/.ssh/deploy_key
          echo "âœ… SSH cleanup complete"

  # =============================================================================
  # JOB 2: ROLLBACK (Ø§Ú¯Ø± deployment Ù†Ø§Ú©Ø§Ù… ÛÙˆ)
  # Automatic rollback if deployment fails
  # =============================================================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()  # ØµØ±Ù Ø§Ú¯Ø± deploy job fail ÛÙˆ
                   # Only if deploy job fails
    
    steps:
      - name: ğŸ” Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts

      - name: âª Rollback to Previous Version
        run: |
          ssh -i ~/.ssh/deploy_key root@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_PATH
            
            echo 'âš ï¸  Deployment failed! Rolling back...'
            echo 'âš ï¸  ÚˆÛŒÙ¾Ù„Ø§Ø¦Ù…Ù†Ù¹ Ù†Ø§Ú©Ø§Ù…! Ù¾Ú†Ú¾Ù„ÛŒ version Ù¾Ø± ÙˆØ§Ù¾Ø³ Ø¬Ø§ Ø±ÛÛ’ ÛÛŒÚº...'
            
            # Ù¾Ú†Ú¾Ù„ÛŒ successful commit Ù¾Ø± ÙˆØ§Ù¾Ø³ Ø¬Ø§Ù†Ø§
            # Go back to last successful commit
            if [ -f .last_successful_deploy ]; then
              LAST_COMMIT=\$(cat .last_successful_deploy)
              if [ \"\$LAST_COMMIT\" != 'first_deploy' ]; then
                git reset --hard \$LAST_COMMIT
                
                # Ù¾Ø±Ø§Ù†ÛŒ containers restart Ú©Ø±Ù†Ø§
                # Restart old containers
                docker-compose -f docker-compose.yml -f docker-compose.prod.yml down
                docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
                
                echo 'âœ… Rollback successful!'
                echo 'âœ… Ø±ÙˆÙ„ Ø¨ÛŒÚ© Ú©Ø§Ù…ÛŒØ§Ø¨!'
              else
                echo 'âš ï¸  No previous deployment found'
                echo 'âš ï¸  Ú©ÙˆØ¦ÛŒ Ù¾Ú†Ú¾Ù„ÛŒ deployment Ù†ÛÛŒÚº Ù…Ù„ÛŒ'
              fi
            fi
          "

      - name: ğŸ“§ Send Failure Notification
        run: |
          echo "âŒ DEPLOYMENT FAILED AND ROLLED BACK"
          echo "Please check the logs and fix the issues before trying again"
          echo ""
          echo "âŒ ÚˆÛŒÙ¾Ù„Ø§Ø¦Ù…Ù†Ù¹ Ù†Ø§Ú©Ø§Ù… Ø§ÙˆØ± Ø±ÙˆÙ„ Ø¨ÛŒÚ© ÛÙˆ Ú¯ÛŒØ§"
          echo "Ø¨Ø±Ø§Û Ú©Ø±Ù… logs Ú†ÛŒÚ© Ú©Ø±ÛŒÚº Ø§ÙˆØ± Ù…Ø³Ø§Ø¦Ù„ Ù¹Ú¾ÛŒÚ© Ú©Ø±ÛŒÚº"

      - name: ğŸ§¹ Cleanup SSH
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

