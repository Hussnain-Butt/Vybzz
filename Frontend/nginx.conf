# =================================================================
# === V Y B Z Z   -   F R O N T E N D   N G I N X   C O N F I G ===
# =================================================================
# This file only contains configuration that belongs INSIDE an 'http' block.
# The main nginx.conf from the base image will provide the 'http' wrapper.

# --- API Gateway Upstream Definition ---
# Hum Nginx ko bata rahe hain ke "api_gateway" naam ka ek server group hai.
# Docker ke andar, 'api-gateway' service ka naam hi uska network address hota hai.
upstream api_gateway {
  # Port 3000 par chalne wali api-gateway service
  server api-gateway:3000;
}

# --- Main Server Block ---
# Yeh hamara web server hai jo port 80 par saari requests sunega.
# Yeh 'server' block 'http' block ke andar rehta hai.
server {
  listen 80;
  server_name localhost;

  # Root directory jahan aapki React app ki build files hain
  root /usr/share/nginx/html;
  index index.html;

  # --- Location Block for Live Streaming (WebSocket) ---
  # YEH SABSE ZAROORI FIX HAI!
  # Jab bhi koi request /stream/ se shuru hogi, yeh block usay handle karega.
  location /stream/ {
    # Request ko foran 'api_gateway' par bhej do.
    proxy_pass http://api_gateway;

    # Yeh 3 lines WebSocket connection ke liye "jaadui" hain.
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    # Kuch aur zaroori headers taake Gateway ko client ki sahi info miley
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # --- Location Block for All Other API Calls ---
  # Yeh block /users, /posts, /auth, etc. jaisi tamam API calls ko pakrega.
  location ~ ^/(users|posts|auth|webhooks)/ {
    # Request ko 'api_gateway' par bhej do.
    proxy_pass http://api_gateway;

    # Standard headers for a reverse proxy.
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # --- Location Block for React App (Single Page Application) ---
  # Yeh "catch-all" block hai.
  location / {
    # Yeh line React Router ko theek se chalane ke liye bohot zaroori hai.
    try_files $uri $uri/ /index.html;
  }

  # Standard error page handling (optional but good practice)
  error_page   500 502 503 504  /50x.html;
  location = /50x.html {
    root   /usr/share/nginx/html;
  }
}