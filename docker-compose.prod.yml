# =============================================================================
# VYBZZ PRODUCTION DOCKER COMPOSE
# =============================================================================
# یہ production environment کے لیے Docker Compose configuration ہے
# This is the Docker Compose configuration for production environment
#
# USAGE / استعمال:
#   docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# یہ file docker-compose.yml کے ساتھ merge ہوتی ہے اور production-specific
# settings override کرتی ہے
#
# This file merges with docker-compose.yml and overrides settings with
# production-specific configurations
# =============================================================================

services:
  # ===========================================================================
  # FRONTEND SERVICE (Production)
  # ===========================================================================
  frontend:
    # Production میں Dockerfile.dev کی بجائے standard Dockerfile استعمال کریں
    # Use standard Dockerfile instead of Dockerfile.dev in production
    build:
      context: ./Frontend
      dockerfile: Dockerfile  # Already optimized multi-stage build
    
    # Container restart policy
    # اگر container fail ہو تو automatically restart ہو
    restart: always
    
    # Production میں volume mounts نہیں چاہیے (security + performance)
    # No volume mounts in production (security + performance)
    volumes: []
    
    # Environment variables (production)
    environment:
      - NODE_ENV=production
    
    # Production میں صرف port 80 expose کریں
    # Only expose port 80 in production
    ports:
      - "80:80"
    
    # Health check (make sure Nginx is responding)
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # POSTGRESQL DATABASE (Production) - DISABLED
  # ===========================================================================
  # Production میں Digital Ocean Managed Database استعمال کر رہے ہیں
  # Using Digital Ocean Managed Database in production
  # 
  # ⚠️ IMPORTANT: postgres container production میں disabled ہے
  # postgres container is disabled in production
  # 
  # External managed database connection strings .env.production میں ہیں
  # External managed database connection strings are in .env.production
  #
  # postgres:
  #   restart: always
  #   environment:
  #     POSTGRES_USER: ${POSTGRES_USER:-postgres}
  #     POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
  #     POSTGRES_DB: ${POSTGRES_DB:-vybzz}
  #   volumes:
  #     - pg_data:/var/lib/postgresql/data
  #   healthcheck:
  #     test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-vybzz} || exit 1']
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #     start_period: 30s

  # ===========================================================================
  # API GATEWAY (Production)
  # ===========================================================================
  api-gateway:
    # Production Dockerfile استعمال کریں
    # Use production Dockerfile
    build:
      context: ./Backend/api-gateway
      dockerfile: Dockerfile.prod  # Will create this
      args:
        NODE_ENV: production
    
    restart: always
    
    # Production میں source code mount نہیں کرتے
    # Don't mount source code in production
    volumes: []
    
    environment:
      NODE_ENV: production
      DOCKER: 'true'
      # Service URLs (internal Docker network)
      AUTH_URL: 'http://auth-service:3001'
      USER_URL: 'http://user-service:3002'
      POST_URL: 'http://post-service:3003'
      LIVESTREAM_URL: 'http://live-streaming-service:3004'
    
    # Health check
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # AUTH SERVICE (Production)
  # ===========================================================================
  auth-service:
    # Production Dockerfile already exists اور optimized ہے
    # Production Dockerfile already exists and is optimized
    build:
      context: ./Backend/services/auth-service
      dockerfile: Dockerfile  # Already production-ready
      args:
        NODE_ENV: production
    
    restart: always
    volumes: []
    
    environment:
      NODE_ENV: production
      PORT: '3001'
      # Environment variables from .env.production will be loaded
    
    # ⚠️ Production میں postgres container dependency removed
    # Removed postgres container dependency in production (using managed DB)
    # depends_on: removed because using external managed database
    
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ===========================================================================
  # USER SERVICE (Production)
  # ===========================================================================
  user-service:
    # Production Dockerfile already exists with Prisma support
    build:
      context: ./Backend/services/user-service
      dockerfile: Dockerfile  # Already production-ready with Prisma
      args:
        NODE_ENV: production
        # Using managed database URL from environment
        DATABASE_URL: ${USER_SERVICE_DATABASE_URL}
    
    restart: always
    volumes: []
    
    environment:
      NODE_ENV: production
      PORT: '3002'
      # Digital Ocean Managed PostgreSQL Database URL (from .env.production)
      DATABASE_URL: ${USER_SERVICE_DATABASE_URL}
      CLERK_WEBHOOK_SIGNING_SECRET: ${CLERK_WEBHOOK_SIGNING_SECRET}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      CLERK_PUBLISHABLE_KEY: ${CLERK_PUBLISHABLE_KEY}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
    
    # DNS settings (IPv6 disable - stability)
    dns:
      - 8.8.8.8
      - 8.8.4.4
    
    sysctls:
      net.ipv6.conf.all.disable_ipv6: 1
    
    # ⚠️ Production میں postgres container dependency removed
    # Removed postgres container dependency (using external managed database)
    
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3002/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # Prisma migrations کے لیے زیادہ وقت

  # ===========================================================================
  # POST SERVICE (Production)
  # ===========================================================================
  post-service:
    build:
      context: ./Backend/services/post-service
      dockerfile: Dockerfile.prod  # Will create optimized version
      args:
        NODE_ENV: production
        # Using managed database URL from environment
        DATABASE_URL: ${POST_SERVICE_DATABASE_URL}
    
    restart: always
    volumes: []
    
    environment:
      NODE_ENV: production
      PORT: '3003'
      # Digital Ocean Managed PostgreSQL Database URL (from .env.production)
      DATABASE_URL: ${POST_SERVICE_DATABASE_URL}
    
    dns:
      - 8.8.8.8
      - 8.8.4.4
    
    sysctls:
      net.ipv6.conf.all.disable_ipv6: 1
    
    # ⚠️ Production میں postgres container dependency removed
    # Removed postgres container dependency (using external managed database)
    
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3003/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================================================
  # LIVE STREAMING SERVICE (Production)
  # ===========================================================================
  live-streaming-service:
    build:
      context: ./Backend/services/live-streaming-service
      dockerfile: Dockerfile  # Already has FFMPEG installed
      args:
        NODE_ENV: production
        # Using managed database URL from environment
        DATABASE_URL: ${LIVESTREAM_SERVICE_DATABASE_URL}
    
    restart: always
    volumes: []
    
    environment:
      NODE_ENV: production
      PORT: '3004'
      # Digital Ocean Managed PostgreSQL Database URL (from .env.production)
      DATABASE_URL: ${LIVESTREAM_SERVICE_DATABASE_URL}
    
    # ⚠️ Production میں postgres container dependency removed
    # Removed postgres container dependency (using external managed database)
    
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3004/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

# =============================================================================
# VOLUMES (Production)
# =============================================================================
# ⚠️ Production میں Digital Ocean Managed Database استعمال کر رہے ہیں
# Using Digital Ocean Managed Database in production
# 
# Local postgres volume کی ضرورت نہیں ہے
# Local postgres volume is not needed
#
# volumes:
#   pg_data:
#     driver: local

# =============================================================================
# NETWORKS (Optional - اگر specific network config چاہیے)
# =============================================================================
# networks:
#   vybzz-network:
#     driver: bridge

# =============================================================================
# NOTES / نوٹس
# =============================================================================
#
# 1. MANAGED DATABASE:
#    ⚠️ Production میں Digital Ocean Managed PostgreSQL استعمال کر رہے ہیں
#    Using Digital Ocean Managed PostgreSQL in production
#    Connection strings .env.production میں ہیں
#    Connection strings are in .env.production
#
# 2. ENVIRONMENT VARIABLES:
#    Production میں .env.production file استعمال کریں
#    Use .env.production file in production
#    سب environment variables وہاں define ہیں
#    All environment variables are defined there
#
# 3. SECRETS MANAGEMENT:
#    Sensitive credentials .env.production میں ہیں
#    Sensitive credentials are in .env.production
#    Server پر secure storage میں رکھیں (chmod 600)
#    Keep in secure storage on server (chmod 600)
#
# 4. VOLUMES:
#    Production میں کوئی volumes نہیں ہیں
#    No volumes in production
#    Database Digital Ocean managed service ہے
#    Database is Digital Ocean managed service
#    Code volumes نہیں ہیں (security)
#    No code volumes (security)
#
# 5. RESTART POLICY:
#    تمام services کی restart policy 'always' ہے
#    All services have restart policy 'always'
#    Server reboot ہونے پر automatically start ہوں گی
#    Will automatically start on server reboot
#
# 6. HEALTH CHECKS:
#    تمام services کی health checks improved ہیں
#    All services have improved health checks
#    Deployment workflow ان کا استعمال کرتا ہے
#    Deployment workflow uses these
#
# 7. SECURITY:
#    - کوئی development dependencies نہیں
#      No development dependencies
#    - Non-root users containers میں
#      Non-root users in containers
#    - کوئی source code mounts نہیں
#      No source code mounts
#    - Minimal base images (Alpine)
#      Minimal base images (Alpine)
#    - SSL enabled for database connections
#      Database connections کے لیے SSL enabled
#
# 8. DEPLOYMENT COMMAND:
#    Server پر یہ command چلائیں:
#    Run this command on server:
#    
#    docker-compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production up -d --build
#
# =============================================================================

